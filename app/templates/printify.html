<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Printify Products</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <link rel="stylesheet" href="/static/ui.css" />
  <style>
    .grid { display:grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: start; }
    .card { position:relative; margin-bottom: 1rem; }
    .status-pill { position:absolute; top:10px; right:10px; padding:0.25rem 0.6rem; border-radius:999px; font-size:0.8em; }
    .pill-published { background:#e6ffed; color:#036d19; border:1px solid #bdf2c7; }
    .pill-unpublished { background:#fff7e6; color:#8a5a00; border:1px solid #ffe0a3; }
    .muted { color:#666; font-size:0.9em; }
    img.thumb { width: 140px; height: 140px; object-fit: cover; border-radius: 8px; border:1px solid #e6e6e6; }
    .pager {
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:.6rem;
      margin:0 0 1rem;
      padding:.75rem .9rem;
      border:1px solid #d9dfe8;
      border-radius:12px;
      background:#f7f9fc;
    }
    .pager-info { font-size:.9rem; color:#516073; }
    .pager-actions { display:flex; align-items:center; flex-wrap:wrap; gap:.45rem; }
    .pager-jumps { display:flex; align-items:center; flex-wrap:wrap; gap:.35rem; }
    .pager-jumps .ellipsis { color:#768398; padding:0 .2rem; font-weight:700; }
  </style>
</head>
<body class="container app-theme">
  <header class="app-topbar">
    <div>
      <h1>Printify Products</h1>
      <p class="topbar-subtitle">Track and edit Printify catalog products in one view.</p>
    </div>
    <nav class="topbar-nav">
      <div class="nav-main">
        <a href="/">Dashboard</a>
        <a href="/shopify">Shopify Products</a>
        <a href="/printify" class="is-active" aria-current="page">Printify Products</a>
        <a href="/personas">Personas</a>
      </div>
      <div class="nav-actions">
        <a href="/printify/new" role="button" class="secondary">New Product</a>
        <button id="updateBtn">Update Cache</button>
      </div>
    </nav>
  </header>

  {% if not items %}
    <p>No cached Printify products yet. Click <b>Update Cache</b> to download.</p>
  {% endif %}

  <main>
    {% if pager %}
      <div class="pager">
        <div class="pager-info">
          {% if pager.show_all %}
            Showing all {{ pager.total_items }} products
          {% else %}
            Page {{ pager.page }} of {{ pager.total_pages }} ({{ pager.total_items }} total)
          {% endif %}
        </div>
        <div class="pager-actions">
          {% if pager.has_prev %}
            <a href="{{ pager.prev_url }}" role="button" class="secondary">← Prev</a>
          {% else %}
            <button type="button" class="secondary" disabled>← Prev</button>
          {% endif %}
          {% if not pager.show_all and pager.total_pages > 1 %}
          <div class="pager-jumps">
            <a href="{{ url_for('printify_pages.printify_page', page=1) }}" role="button" class="{{ 'primary' if pager.page == 1 else 'secondary' }}">1</a>
            {% set window_start = [2, pager.page - 1] | max %}
            {% set window_end = [pager.total_pages - 1, pager.page + 3] | min %}
            {% if window_start > 2 %}<span class="ellipsis">…</span>{% endif %}
            {% for n in range(window_start, window_end + 1) %}
              <a href="{{ url_for('printify_pages.printify_page', page=n) }}" role="button" class="{{ 'primary' if n == pager.page else 'secondary' }}">{{ n }}</a>
            {% endfor %}
            {% if window_end < pager.total_pages - 1 %}<span class="ellipsis">…</span>{% endif %}
            {% if pager.total_pages > 1 %}
              <a href="{{ url_for('printify_pages.printify_page', page=pager.total_pages) }}" role="button" class="{{ 'primary' if pager.page == pager.total_pages else 'secondary' }}">{{ pager.total_pages }}</a>
            {% endif %}
          </div>
          {% endif %}
          {% if pager.has_next %}
            <a href="{{ pager.next_url }}" role="button" class="secondary">Next →</a>
          {% else %}
            <button type="button" class="secondary" disabled>Next →</button>
          {% endif %}
          {% if pager.show_all %}
            <a href="{{ pager.paged_url }}" role="button" class="secondary">Paged view</a>
          {% else %}
            <a href="{{ pager.show_all_url }}" role="button" class="secondary">Show all</a>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% for p in items %}
      <article class="card">
        <span class="status-pill {{ 'pill-published' if p.published else 'pill-unpublished' }}">{{ 'Published' if p.published else 'Unpublished' }}</span>
        <div class="grid">
          <div>
            {% if p.primary_image %}
              <img class="thumb" src="{{ p.primary_image }}" alt="{{ p.title }} image" />
            {% else %}
              <div style="width:140px;height:140px;background:#f3f3f3;border-radius:8px;border:1px solid #e6e6e6;"></div>
            {% endif %}
          </div>
          <div>
            <h3><a href="/printify/edit/{{ p.id }}">{{ p.title }}</a></h3>
            {% if p.shopify_url %}
              <p><a href="{{ p.shopify_url }}" target="_blank">View on Shopify</a></p>
            {% endif %}
            <p class="muted">
              {% if p.created_at %}
                Created: {{ p.created_at }}
              {% elif p.updated_at %}
                Updated: {{ p.updated_at }}
              {% endif %}
            </p>
          </div>
        </div>
      </article>
    {% endfor %}

    {% if pager and not pager.show_all and pager.total_pages > 1 %}
      <div class="pager" style="margin-top:1rem;">
        <div class="pager-info">Page {{ pager.page }} of {{ pager.total_pages }}</div>
        <div class="pager-actions">
          {% if pager.has_prev %}
            <a href="{{ pager.prev_url }}" role="button" class="secondary">← Prev</a>
          {% endif %}
          <div class="pager-jumps">
            <a href="{{ url_for('printify_pages.printify_page', page=1) }}" role="button" class="{{ 'primary' if pager.page == 1 else 'secondary' }}">1</a>
            {% set window_start = [2, pager.page - 1] | max %}
            {% set window_end = [pager.total_pages - 1, pager.page + 3] | min %}
            {% if window_start > 2 %}<span class="ellipsis">…</span>{% endif %}
            {% for n in range(window_start, window_end + 1) %}
              <a href="{{ url_for('printify_pages.printify_page', page=n) }}" role="button" class="{{ 'primary' if n == pager.page else 'secondary' }}">{{ n }}</a>
            {% endfor %}
            {% if window_end < pager.total_pages - 1 %}<span class="ellipsis">…</span>{% endif %}
            {% if pager.total_pages > 1 %}
              <a href="{{ url_for('printify_pages.printify_page', page=pager.total_pages) }}" role="button" class="{{ 'primary' if pager.page == pager.total_pages else 'secondary' }}">{{ pager.total_pages }}</a>
            {% endif %}
          </div>
          {% if pager.has_next %}
            <a href="{{ pager.next_url }}" role="button" class="secondary">Next →</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </main>

<script>
  document.getElementById('updateBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('updateBtn');
    btn.setAttribute('aria-busy','true');
    try{
      // Use body param or set PRINTIFY_SHOP_ID in .env
      const res = await fetch('/api/printify/products/cache/update', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({}) // or {"shop_id":"123456"}
      });
      await res.json();
      location.reload();
    }catch(e){ alert('Failed to update cache'); }
  });
</script>
</body>
</html>
