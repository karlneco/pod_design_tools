<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit Persona</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
  <link rel="stylesheet" href="/static/ui.css"/>
  <style>
    .layout{display:grid;grid-template-columns:280px 1fr;gap:1rem;align-items:start}
    .muted{color:#666}
    .preview img{width:100%;aspect-ratio:1/1;object-fit:cover;object-position:top center;border-radius:10px;border:1px solid #d8dfeb}
    .actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-top:.8rem}
    textarea[name="notes"]{min-height:200px}
    textarea[name="generation_prompt"]{min-height:140px}
    .render-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.8rem;margin-top:.8rem}
    .render-tile{border:1px solid #d6dbe6;border-radius:10px;padding:.45rem;background:#f9fbff}
    .render-tile.is-main{border:3px solid #b7d8f5;box-shadow:0 0 0 1px rgba(183,216,245,.75)}
    .render-tile img{width:100%;aspect-ratio:1/1;object-fit:cover;object-position:top center;border-radius:8px;display:block;cursor:zoom-in}
    .render-meta-row{margin-top:.35rem;display:flex;align-items:center;justify-content:space-between;gap:.4rem}
    .render-meta{font-size:.78rem;color:#627081;line-height:1.2}
    .render-quality{font-size:.68rem;font-weight:700;line-height:1;padding:.2rem .42rem;border-radius:999px;display:none}
    .render-quality.q-2k{display:inline-block;background:#fff4c7;color:#8a6500;border:1px solid #eedf98}
    .render-quality.q-4k{display:inline-block;background:#f8d7da;color:#8b1e2b;border:1px solid #edb6be}
    .render-actions{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.35rem;
      margin-top:.35rem;
      align-items:stretch;
    }
    .render-actions button{
      width:100%;
      margin:0;
      padding:.38rem .5rem;
      font-size:.76rem;
      line-height:1.1;
      text-align:center;
      white-space:nowrap;
    }
    .render-actions .slot-view{grid-column:1;grid-row:1}
    .render-actions .slot-main{grid-column:2;grid-row:1}
    .render-actions .slot-persona{grid-column:1;grid-row:2}
    .render-actions .slot-empty{grid-column:2;grid-row:2}
    .render-actions .slot-prompt{grid-column:1;grid-row:3}
    .render-actions .slot-delete{grid-column:2;grid-row:3}
    .render-actions .action-spacer{display:block}
    .btn-view{background:#0b75ad;border-color:#0b75ad;color:#fff}
    .btn-view:hover{background:#0a6798;border-color:#0a6798}
    .btn-neutral{background:#4f5f7d;border-color:#4f5f7d;color:#fff}
    .btn-neutral:hover{background:#445471;border-color:#445471}
    .btn-delete{background:#a33232;border-color:#a33232;color:#fff}
    .btn-delete:hover{background:#8f2b2b;border-color:#8f2b2b}
    .main-pill{display:inline-block;margin-top:.25rem;padding:.12rem .5rem;border-radius:999px;font-size:.72rem;font-weight:700;background:#e6f2ff;color:#165f97}
    .ref-chip{display:inline-block;margin-top:.25rem;padding:.1rem .45rem;border-radius:999px;font-size:.68rem;font-weight:700;background:#efe8ff;color:#5f3ea9}
    .active-ref{margin-top:.35rem;padding:.35rem .55rem;border:1px solid #d9dff0;border-radius:10px;background:#f8faff;font-size:.82rem;color:#4b5872}
    .viewer{position:fixed;inset:0;background:rgba(0,0,0,.82);display:none;align-items:center;justify-content:center;z-index:1000}
    .viewer.open{display:flex}
    .viewer-wrap{max-width:min(1080px,95vw);max-height:92vh;display:flex;flex-direction:column;gap:.6rem}
    .viewer-wrap img{max-width:min(1080px,95vw);max-height:72vh;object-fit:contain;background:#111;border:1px solid #333;border-radius:12px}
    .viewer-meta{background:#f3f6fb;border-radius:10px;padding:.45rem .7rem;font-size:.8rem;color:#3f4b60}
    .viewer-prompt{background:#fff;border-radius:10px;padding:.7rem .8rem;max-height:16vh;overflow:auto;font-size:.86rem}
    .viewer-nav{position:fixed;top:50%;transform:translateY(-50%);font-size:1.2rem;line-height:1;padding:.55rem .7rem}
    #viewerPrev{left:18px}
    #viewerNext{right:18px}
    #viewerClose{position:fixed;top:16px;right:16px}
    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      .render-grid{grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
    }
  </style>
</head>
<body class="container app-theme">
<header class="app-topbar">
  <div>
    <h1>Edit Persona</h1>
    <p class="topbar-subtitle">Update profile details, photo, and active state.</p>
  </div>
  <nav class="topbar-nav">
    <div class="nav-main">
      <a href="/">Dashboard</a>
      <a href="/shopify">Shopify Products</a>
      <a href="/printify">Printify Products</a>
      <a href="/personas" class="is-active" aria-current="page">Personas</a>
    </div>
    <div class="nav-actions">
      <a href="/personas" role="button" class="secondary">Back to Personas</a>
    </div>
  </nav>
</header>

<main class="layout">
  <section class="preview">
    <article>
      <img src="{{ persona.image_url }}" alt="{{ persona.label }}">
      <p style="margin-top:.6rem;"><b>{{ persona.label }}</b></p>
      {% if persona.archetype %}<p class="muted">{{ persona.archetype }}</p>{% endif %}
      {% if persona.occupation %}<p class="muted">Occupation: {{ persona.occupation }}</p>{% endif %}
      {% if persona.location %}<p class="muted">Location: {{ persona.location }}</p>{% endif %}
      <p class="muted">Source: {{ persona.source or 'upload' }}{% if not persona.active %} (inactive){% endif %}</p>
    </article>
  </section>
  <section>
    <article>
      <h3>Persona Details</h3>
      <form id="editForm" enctype="multipart/form-data">
        <label>Name<input type="text" name="label" value="{{ persona.label }}" required/></label>
        <label>
          Gender
          <select name="gender">
            {% set g = (persona.gender or 'unspecified') %}
            <option value="unspecified" {% if g == 'unspecified' %}selected{% endif %}>Unspecified</option>
            <option value="male" {% if g == 'male' %}selected{% endif %}>Male</option>
            <option value="female" {% if g == 'female' %}selected{% endif %}>Female</option>
            <option value="non-binary" {% if g == 'non-binary' %}selected{% endif %}>Non-binary</option>
          </select>
        </label>
        <label>Age segments (comma-separated)<input type="text" name="age_segments" value="{{ (persona.age_options or age_segments) | join(', ') }}"/></label>
        <label>Core Persona / Archetype<input type="text" name="archetype" value="{{ persona.archetype or '' }}" placeholder="e.g. THE HERITAGE CONNECTOR"/></label>
        <label>Location<input type="text" name="location" value="{{ persona.location or '' }}" placeholder="e.g. Tokyo cafes, weekend markets"/></label>
        <label>Occupation<input type="text" name="occupation" value="{{ persona.occupation or '' }}" placeholder="e.g. Product designer"/></label>
        <label>
          Frame
          {% set orient = persona.generation_orientation or 'portrait' %}
          <select name="generation_orientation">
            <option value="portrait" {% if orient == 'portrait' %}selected{% endif %}>Portrait (3:4)</option>
            <option value="square" {% if orient == 'square' %}selected{% endif %}>Square (1:1)</option>
          </select>
        </label>
        <label>
          Output size
          {% set gres = persona.generation_resolution or 2048 %}
          <select name="generation_resolution">
            <option value="1024" {% if gres == 1024 %}selected{% endif %}>1K (1024)</option>
            <option value="2048" {% if gres == 2048 %}selected{% endif %}>2K (2048)</option>
            <option value="4096" {% if gres == 4096 %}selected{% endif %}>4K</option>
          </select>
        </label>
        <label>Generation Prompt<textarea name="generation_prompt" placeholder="Prompt used for generated persona renders">{{ persona.generation_prompt or '' }}</textarea></label>
        <div id="activeReference" class="active-ref">Persona reference: none</div>
        <label>Notes<textarea name="notes">{{ persona.notes or '' }}</textarea></label>
        <label>Replace photo (optional)<input type="file" name="photo" accept=".png,.jpg,.jpeg,.webp,image/*"/></label>
        <label style="display:flex;gap:.5rem;align-items:center;">
          <input type="checkbox" name="active" {% if persona.active %}checked{% endif %}/>
          <span>Active</span>
        </label>
        <div class="actions">
          <button type="submit">Save</button>
          <button type="button" id="regenBtn" class="secondary">Regenerate</button>
          <button type="button" class="secondary" id="deleteBtn">Delete Persona</button>
          <small id="status" class="muted"></small>
        </div>
      </form>
    </article>

    <article>
      <h3>Generated Renders</h3>
      <p class="muted">Keep all renders/prompts and choose one main image for this persona.</p>
      <div id="renderGrid" class="render-grid"></div>
    </article>
  </section>
</main>

<div id="viewer" class="viewer" role="dialog" aria-modal="true">
  <button id="viewerClose" class="secondary">Close</button>
  <button id="viewerPrev" class="secondary viewer-nav" aria-label="Previous image">◀</button>
  <button id="viewerNext" class="secondary viewer-nav" aria-label="Next image">▶</button>
  <div class="viewer-wrap">
    <img id="viewerImage" src="" alt="Persona render preview">
    <div id="viewerMeta" class="viewer-meta"></div>
    <div id="viewerPrompt" class="viewer-prompt"></div>
  </div>
</div>

<script>
const personaId = {{ persona.id | tojson }};
const form = document.getElementById('editForm');
const statusEl = document.getElementById('status');
const renderGridEl = document.getElementById('renderGrid');
const activeReferenceEl = document.getElementById('activeReference');
const viewer = document.getElementById('viewer');
const viewerImage = document.getElementById('viewerImage');
const viewerMeta = document.getElementById('viewerMeta');
const viewerPrompt = document.getElementById('viewerPrompt');
const generationPromptEl = form.querySelector('textarea[name="generation_prompt"]');
const generationOrientationEl = form.querySelector('select[name="generation_orientation"]');
const generationResolutionEl = form.querySelector('select[name="generation_resolution"]');
let persona = {{ persona | tojson }};
let selectedReferenceFilename = '';
let viewerEntries = [];
let viewerIndex = -1;

function refreshActiveReferenceLabel() {
  activeReferenceEl.textContent = selectedReferenceFilename
    ? `Persona reference: ${selectedReferenceFilename}`
    : 'Persona reference: none';
}

function renderHistoryGrid() {
  const history = Array.isArray(persona.render_history) ? persona.render_history : [];
  viewerEntries = history.slice().reverse();
  renderGridEl.innerHTML = '';
  for (const entry of viewerEntries) {
    const isMain = String(entry.filename || '') === String(persona.image_filename || '');
    const tile = document.createElement('div');
    tile.className = `render-tile ${isMain ? 'is-main' : ''}`;
    const usedAsRef = String(entry.reference_filename || '').trim();
    const isSelectedRef = String(entry.filename || '') === String(selectedReferenceFilename || '');
    tile.innerHTML = `
      <img src="${entry.image_url}" alt="${persona.label} render">
      ${isMain ? '<span class="main-pill">Main</span>' : ''}
      ${usedAsRef ? `<span class="ref-chip">Ref: ${usedAsRef}</span>` : ''}
      ${isSelectedRef ? '<span class="ref-chip">Selected Persona</span>' : ''}
      <div class="render-meta-row">
        <div class="render-meta">${entry.created_at ? String(entry.created_at).replace('T', ' ').slice(0, 16) : ''}</div>
        <span class="render-quality"></span>
      </div>
      <div class="render-actions">
        <button type="button" data-act="view" class="btn-view slot-view">View</button>
        <button type="button" data-act="set-main" class="btn-neutral slot-main" ${isMain ? 'disabled' : ''}>${isMain ? 'Main Image' : 'Set Main'}</button>
        <button type="button" data-act="use-persona" class="btn-neutral slot-persona">Use Persona</button>
        <span class="action-spacer slot-empty"></span>
        <button type="button" data-act="use-prompt" class="btn-neutral slot-prompt">Use Prompt</button>
        <button type="button" data-act="delete-image" class="btn-delete slot-delete" ${(viewerEntries.length <= 1) ? 'disabled' : ''}>Delete</button>
      </div>
    `;
    tile.querySelector('[data-act="view"]').addEventListener('click', () => {
      const idx = viewerEntries.findIndex((it) => String(it.filename || '') === String(entry.filename || ''));
      openViewerAt(idx >= 0 ? idx : 0);
    });
    const imgEl = tile.querySelector('img');
    const qualityEl = tile.querySelector('.render-quality');
    const updateQualityBadge = () => {
      const longEdge = Math.max(imgEl.naturalWidth || 0, imgEl.naturalHeight || 0);
      qualityEl.className = 'render-quality';
      qualityEl.textContent = '';
      if (longEdge >= 3800) {
        qualityEl.textContent = '4K';
        qualityEl.classList.add('q-4k');
      } else if (longEdge >= 2000) {
        qualityEl.textContent = '2K';
        qualityEl.classList.add('q-2k');
      }
    };
    imgEl.addEventListener('load', updateQualityBadge);
    if (imgEl.complete) updateQualityBadge();
    imgEl.addEventListener('click', () => {
      const idx = viewerEntries.findIndex((it) => String(it.filename || '') === String(entry.filename || ''));
      openViewerAt(idx >= 0 ? idx : 0);
    });
    tile.querySelector('[data-act="use-persona"]').addEventListener('click', () => {
      selectedReferenceFilename = String(entry.filename || '');
      refreshActiveReferenceLabel();
      renderHistoryGrid();
    });
    tile.querySelector('[data-act="use-prompt"]').addEventListener('click', () => {
      generationPromptEl.value = entry.prompt || '';
    });
    tile.querySelector('[data-act="set-main"]').addEventListener('click', async () => {
      statusEl.textContent = 'Setting main image...';
      const res = await fetch(`/api/personas/${encodeURIComponent(personaId)}/main-image`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ filename: entry.filename }),
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.textContent = `Error: ${data.error || 'Failed to set main image'}`;
        return;
      }
      persona = data.persona;
      statusEl.textContent = 'Main image updated.';
      renderHistoryGrid();
    });
    tile.querySelector('[data-act="delete-image"]').addEventListener('click', async () => {
      if (!confirm(`Delete image ${entry.filename}?`)) return;
      statusEl.textContent = 'Deleting image...';
      const res = await fetch(`/api/personas/${encodeURIComponent(personaId)}/images/delete`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ filename: entry.filename }),
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.textContent = `Error: ${data.error || 'Failed to delete image'}`;
        return;
      }
      if (selectedReferenceFilename === entry.filename) {
        selectedReferenceFilename = '';
        refreshActiveReferenceLabel();
      }
      persona = data.persona;
      statusEl.textContent = 'Image deleted.';
      renderHistoryGrid();
    });
    renderGridEl.appendChild(tile);
  }
}

function openViewerAt(index) {
  if (!viewerEntries.length) return;
  viewerIndex = (index + viewerEntries.length) % viewerEntries.length;
  const entry = viewerEntries[viewerIndex];
  viewerImage.src = entry.image_url;
  viewerMeta.textContent = `File: ${entry.filename || 'unknown'} | Size: loading...`;
  viewerImage.onload = () => {
    const w = viewerImage.naturalWidth || 0;
    const h = viewerImage.naturalHeight || 0;
    viewerMeta.textContent = `File: ${entry.filename || 'unknown'} | Size: ${w}x${h}`;
  };
  const refLine = entry.reference_filename ? `Reference persona image: ${entry.reference_filename}\n\n` : '';
  viewerPrompt.textContent = `${refLine}${entry.prompt || '(No prompt saved for this image)'}`;
  viewer.classList.add('open');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  fd.set('active', fd.get('active') ? 'true' : 'false');
  statusEl.textContent = 'Saving...';
  const res = await fetch(`/api/personas/${encodeURIComponent(personaId)}`, { method: 'POST', body: fd });
  const data = await res.json();
  if (!res.ok) {
    statusEl.textContent = `Error: ${data.error || 'Save failed'}`;
    return;
  }
  persona = data.persona;
  statusEl.textContent = 'Saved.';
  renderHistoryGrid();
});

document.getElementById('regenBtn').addEventListener('click', async () => {
  const prompt = (generationPromptEl.value || '').trim();
  statusEl.textContent = 'Regenerating...';
  const res = await fetch(`/api/personas/${encodeURIComponent(personaId)}/regenerate`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      prompt,
      generation_orientation: String(generationOrientationEl.value || 'portrait'),
      generation_resolution: Number(generationResolutionEl.value || 2048),
      reference_filename: selectedReferenceFilename || '',
      set_as_main: false
    }),
  });
  const data = await res.json();
  if (!res.ok) {
    statusEl.textContent = `Error: ${data.error || 'Regenerate failed'}`;
    return;
  }
  persona = data.persona;
  generationPromptEl.value = persona.generation_prompt || generationPromptEl.value;
  statusEl.textContent = 'Regenerated. Choose "Set Main" on any render.';
  renderHistoryGrid();
});

document.getElementById('deleteBtn').addEventListener('click', async () => {
  if (!confirm('Delete this persona?')) return;
  statusEl.textContent = 'Deleting...';
  const res = await fetch(`/api/personas/${encodeURIComponent(personaId)}?delete_image=true`, { method: 'DELETE' });
  const data = await res.json();
  if (!res.ok) {
    statusEl.textContent = `Error: ${data.error || 'Delete failed'}`;
    return;
  }
  location.href = '/personas';
});

document.getElementById('viewerClose').addEventListener('click', () => viewer.classList.remove('open'));
document.getElementById('viewerPrev').addEventListener('click', () => openViewerAt(viewerIndex - 1));
document.getElementById('viewerNext').addEventListener('click', () => openViewerAt(viewerIndex + 1));
viewer.addEventListener('click', (e) => {
  if (e.target === viewer) viewer.classList.remove('open');
});
document.addEventListener('keydown', (e) => {
  if (!viewer.classList.contains('open')) return;
  if (e.key === 'ArrowLeft') {
    e.preventDefault();
    openViewerAt(viewerIndex - 1);
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    openViewerAt(viewerIndex + 1);
  } else if (e.key === 'Escape') {
    e.preventDefault();
    viewer.classList.remove('open');
  }
});

renderHistoryGrid();
refreshActiveReferenceLabel();
</script>
</body>
</html>
