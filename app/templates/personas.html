<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Personas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
  <link rel="stylesheet" href="/static/ui.css"/>
  <style>
    .persona-gallery-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(188px,188px));
      justify-content:flex-start;
      gap:.7rem;
    }
    .persona-tile{
      padding:.5rem;
      border:1px solid #d3d9e4;
      border-radius:12px;
      background:#f9fbff;
    }
    .persona-tile img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      object-position: top center;
      border-radius:8px;
      border:1px solid #d8dfeb;
      display:block;
    }
    .persona-meta{margin-top:.35rem}
    .persona-name-row{display:flex;align-items:baseline;justify-content:space-between;gap:.35rem}
    .persona-name{font-weight:700;font-size:.95rem;margin:0}
    .persona-gender{margin:0;color:#647185;font-size:.78rem;font-weight:700}
    .persona-detail{margin:0;color:#5e6a7b;font-size:.82rem;line-height:1.2}
    .persona-link{display:block;color:inherit;text-decoration:none}
    .persona-link:hover{text-decoration:none}
    .muted{color:#666}
    @media (max-width:900px){ .persona-gallery-grid{grid-template-columns:repeat(auto-fill,minmax(146px,1fr))} }
  </style>
</head>
<body class="container app-theme">
<header class="app-topbar">
  <div>
    <h1>Personas</h1>
    <p class="topbar-subtitle">Create, edit, and generate reusable lifestyle personas.</p>
  </div>
  <nav class="topbar-nav">
    <div class="nav-main">
      <a href="/">Dashboard</a>
      <a href="/shopify">Shopify Products</a>
      <a href="/printify">Printify Products</a>
      <a href="/personas" class="is-active" aria-current="page">Personas</a>
    </div>
    <div class="nav-actions">
      <a href="#createPersonaCard" role="button" class="secondary">New Persona</a>
    </div>
  </nav>
</header>

<section>
  <h3>Persona Gallery</h3>
  <div id="personaGallery" class="persona-gallery-grid"></div>
</section>

<main>
  <article id="createPersonaCard">
    <h3>Create Persona</h3>
    <form id="createForm" enctype="multipart/form-data">
      <label>Name<input type="text" name="label" required/></label>
      <label>
        Gender
        <select name="gender">
          <option value="unspecified" selected>Unspecified</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="non-binary">Non-binary</option>
        </select>
      </label>
      <label>Age segments (comma-separated)<input type="text" name="age_segments" value="{{ age_segments | join(', ') }}"/></label>
      <label>Core Persona / Archetype<input type="text" name="archetype" placeholder="e.g. THE UNDERSTATED MINIMALIST"/></label>
      <label>Location<input type="text" name="location" placeholder="e.g. Osaka city neighborhoods"/></label>
      <label>Occupation<input type="text" name="occupation" placeholder="e.g. Creative director"/></label>
      <label>Notes<textarea name="notes"></textarea></label>
      <label>Photo<input type="file" name="photo" accept=".png,.jpg,.jpeg,.webp,image/*" required/></label>
      <button type="submit">Create Persona</button>
    </form>
  </article>
  <article>
    <h3>Generate Persona</h3>
    <p class="muted">Creates a neutral studio full-body “blank canvas” persona (white tee + jeans).</p>
    <form id="genForm">
      <label>Name<input type="text" name="label" required/></label>
      <label>
        Gender
        <select name="gender">
          <option value="unspecified" selected>Unspecified</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="non-binary">Non-binary</option>
        </select>
      </label>
      <label>Age segments (comma-separated)<input type="text" name="age_segments" value="{{ age_segments | join(', ') }}"/></label>
      <label>Core Persona / Archetype<input type="text" name="archetype" placeholder="e.g. THE HERITAGE CONNECTOR"/></label>
      <label>Location<input type="text" name="location" placeholder="e.g. Kyoto side streets"/></label>
      <label>Occupation<input type="text" name="occupation" placeholder="e.g. Museum curator"/></label>
      <label>
        Frame
        <select name="generation_orientation">
          <option value="portrait" selected>Portrait (3:4)</option>
          <option value="square">Square (1:1)</option>
        </select>
      </label>
      <label>
        Output size
        <select name="generation_resolution">
          <option value="1024">1K (1024)</option>
          <option value="2048" selected>2K (2048)</option>
          <option value="4096">4K</option>
        </select>
      </label>
      <label>Persona brief<textarea name="brief" placeholder="e.g. Japanese woman, late 20s, short black hair, calm expression"></textarea></label>
      <label>Notes<textarea name="notes"></textarea></label>
      <button type="submit">Generate Persona</button>
    </form>
    <small id="status" class="muted"></small>
  </article>
</main>

<script>
const galleryEl = document.getElementById('personaGallery');
const statusEl = document.getElementById('status');

function inferGender(persona) {
  const fromField = String(persona.gender || "").trim().toLowerCase();
  if (fromField) return fromField;
  const haystack = `${persona.label || ""} ${persona.notes || ""}`.toLowerCase();
  if (/\b(male|man|boy|mens)\b/.test(haystack)) return "male";
  if (/\b(female|woman|girl|womens)\b/.test(haystack)) return "female";
  return "unspecified";
}

function genderShort(persona) {
  const g = inferGender(persona);
  if (g === 'male') return 'M';
  if (g === 'female') return 'F';
  if (g === 'non-binary') return 'NB';
  return '—';
}

function summarizeAge(persona) {
  const ages = Array.isArray(persona.age_options) ? persona.age_options : [];
  return ages.length ? ages.join(", ") : "All ages";
}

async function loadPersonas() {
  const res = await fetch('/api/personas');
  const data = await res.json();
  galleryEl.innerHTML = '';
  for (const p of (data.personas || [])) {
    const tile = document.createElement('div');
    tile.className = 'persona-tile';
    tile.innerHTML = `
      <a class="persona-link" href="/personas/${encodeURIComponent(p.id)}/edit">
        <img src="${p.image_url}" alt="${p.label}">
        <div class="persona-meta">
          <div class="persona-name-row">
            <p class="persona-name">${p.label || 'Untitled persona'}</p>
            <p class="persona-gender">${genderShort(p)}</p>
          </div>
          <p class="persona-detail">${summarizeAge(p)}</p>
        </div>
      </a>
    `;
    galleryEl.appendChild(tile);
  }
}

document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const r = await fetch('/api/personas', { method: 'POST', body: fd });
  const j = await r.json();
  if (!r.ok) {
    statusEl.textContent = `Error: ${j.error || 'Create failed'}`;
    return;
  }
  statusEl.textContent = 'Created.';
  e.target.reset();
  loadPersonas();
});

document.getElementById('genForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    label: String(fd.get('label') || '').trim(),
    gender: String(fd.get('gender') || 'unspecified').trim(),
    age_segments: String(fd.get('age_segments') || '').split(',').map(x => x.trim()).filter(Boolean),
    archetype: String(fd.get('archetype') || '').trim(),
    location: String(fd.get('location') || '').trim(),
    occupation: String(fd.get('occupation') || '').trim(),
    generation_orientation: String(fd.get('generation_orientation') || 'portrait').trim(),
    generation_resolution: Number(fd.get('generation_resolution') || 2048),
    brief: String(fd.get('brief') || '').trim(),
    notes: String(fd.get('notes') || '').trim(),
  };
  statusEl.textContent = 'Generating persona...';
  const r = await fetch('/api/personas/generate', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload),
  });
  const j = await r.json();
  if (!r.ok) {
    statusEl.textContent = `Error: ${j.error || 'Generation failed'}`;
    return;
  }
  statusEl.textContent = 'Generated.';
  e.target.reset();
  loadPersonas();
});

loadPersonas();
</script>
</body>
</html>
