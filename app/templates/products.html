<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Shopify Products</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="/static/ui.css"/>
    <style>
        .grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 1rem;
            align-items: start;
        }

        .card {
            position: relative;
            margin-bottom: 1rem;
        }

        .status-pill {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8em;
        }

        .pill-active {
            background: #e6ffed;
            color: #036d19;
            border: 1px solid #bdf2c7;
        }

        .pill-draft {
            background: #fff7e6;
            color: #8a5a00;
            border: 1px solid #ffe0a3;
        }

        .pill-archived {
            background: #f2f2f2;
            color: #666;
            border: 1px solid #ddd;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .tags span {
            background: #eef;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            display: inline-block;
            white-space: nowrap; /* prevent internal line breaks */
            overflow: hidden; /* handle very long tags gracefully */
            text-overflow: ellipsis; /* ellipsis if container is too narrow */
            word-break: keep-all; /* avoid breaking inside words */
            hyphens: none;
            -webkit-hyphens: none;
        }

        .variants {
            font-size: 0.9em;
            color: #555;
        }

        /* (kept for future use) */
        .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-top: .25rem;
        }

        .color-item {
            width: 72px;
            text-align: center;
        }

        .color-item img {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }

        .color-item .label {
            display: block;
            margin-top: .25rem;
            font-size: .75em;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .muted {
            color: #666;
            font-size: 0.9em;
        }
        .swatch-state {
            margin-top: .35rem;
            font-size: .85em;
        }
        .swatch-ok { color: #036d19; }
        .swatch-warn { color: #8a5a00; }
        .swatch-unknown { color: #666; }

        /* Rich description rendering */
        .desc-wrap {
            margin-top: .25rem;
        }

        .desc-wrap > summary {
            cursor: pointer;
            user-select: none;
            font-size: .85em;
            color: #444;
            list-style: none;
        }

        .desc-wrap > summary::marker {
            content: "";
        }

        .desc {
            max-height: 9rem;
            overflow: hidden;
            position: relative;
        }

        .desc.fade::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2.5rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0), #fff);
        }

        /* Make arbitrary HTML play nice inside cards */
        .desc img, .desc video, .desc iframe {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }

        .desc p {
            margin: 0 0 .5rem;
        }

        .desc ul, .desc ol {
            margin: 0 0 .5rem 1.25rem;
        }

        details[open] .desc {
            max-height: none;
        }

        details[open] .desc.fade::after {
            display: none;
        }

        .pager {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: .6rem;
            margin: 0 0 1rem;
            padding: .75rem .9rem;
            border: 1px solid #d9dfe8;
            border-radius: 12px;
            background: #f7f9fc;
        }
        .pager-info {
            font-size: .9rem;
            color: #516073;
        }
        .pager-actions {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: .45rem;
        }
        .pager-jumps {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: .35rem;
        }
        .pager-jumps .ellipsis {
            color: #768398;
            padding: 0 .2rem;
            font-weight: 700;
        }
    </style>
</head>

{% macro pretty_date(iso) -%}
    {%- if iso -%}
        {%- set dt = iso | replace("Z","+00:00") | todatetime -%}
        {{ dt.strftime("%B %-d, %Y - %-I:%M%p") }}
    {%- endif -%}
{%- endmacro %}

<body class="container app-theme">
<header class="app-topbar">
    <div>
        <h1>Shopify Products</h1>
        <p class="topbar-subtitle">Manage listings, mockups, and synchronized media.</p>
    </div>
    <nav class="topbar-nav">
        <div class="nav-main">
            <a href="/">Dashboard</a>
            <a href="/shopify" class="is-active" aria-current="page">Shopify Products</a>
            <a href="/printify">Printify Products</a>
            <a href="/personas">Personas</a>
        </div>
        <div class="nav-actions">
            <button id="updateBtn">Update Cache</button>
        </div>
    </nav>
</header>

{% if not products %}
    <p>No cached products yet. Click <b>Update Cache</b> to download from Shopify.</p>
{% endif %}

<main>
    {% if pager %}
    <div class="pager">
        <div class="pager-info">
            {% if pager.show_all %}
                Showing all {{ pager.total_items }} products
            {% else %}
                Page {{ pager.page }} of {{ pager.total_pages }} ({{ pager.total_items }} total)
            {% endif %}
        </div>
        <div class="pager-actions">
            {% if pager.has_prev %}
                <a href="{{ pager.prev_url }}" role="button" class="secondary">← Prev</a>
            {% else %}
                <button type="button" class="secondary" disabled>← Prev</button>
            {% endif %}
            {% if not pager.show_all and pager.total_pages > 1 %}
            <div class="pager-jumps">
                <a href="{{ url_for('shopify_pages.products_page', page=1) }}" role="button" class="{{ 'primary' if pager.page == 1 else 'secondary' }}">1</a>
                {% set window_start = [2, pager.page - 1] | max %}
                {% set window_end = [pager.total_pages - 1, pager.page + 3] | min %}
                {% if window_start > 2 %}<span class="ellipsis">…</span>{% endif %}
                {% for n in range(window_start, window_end + 1) %}
                    <a href="{{ url_for('shopify_pages.products_page', page=n) }}" role="button" class="{{ 'primary' if n == pager.page else 'secondary' }}">{{ n }}</a>
                {% endfor %}
                {% if window_end < pager.total_pages - 1 %}<span class="ellipsis">…</span>{% endif %}
                {% if pager.total_pages > 1 %}
                    <a href="{{ url_for('shopify_pages.products_page', page=pager.total_pages) }}" role="button" class="{{ 'primary' if pager.page == pager.total_pages else 'secondary' }}">{{ pager.total_pages }}</a>
                {% endif %}
            </div>
            {% endif %}
            {% if pager.has_next %}
                <a href="{{ pager.next_url }}" role="button" class="secondary">Next →</a>
            {% else %}
                <button type="button" class="secondary" disabled>Next →</button>
            {% endif %}
            {% if pager.show_all %}
                <a href="{{ pager.paged_url }}" role="button" class="secondary">Paged view</a>
            {% else %}
                <a href="{{ pager.show_all_url }}" role="button" class="secondary">Show all</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% for p in products %}
        <article class="card">
            {% set s = (p.status or 'unknown')|lower %}
            <span class="status-pill {% if s=='active' %}pill-active{% elif s=='draft' %}pill-draft{% elif s=='archived' %}pill-archived{% endif %}">{{ p.status or 'unknown' }}</span>
            <div class="grid">
                <div>
                    {% if p.primary_image %}
                        <a href="{{ p.url }}" target="_blank">
                            <img src="{{ p.primary_image }}" alt="{{ p.title }} image"
                                 style="max-width: 200px; height: auto; border-radius:8px;"/>
                        </a>
                        {% if p.url %}
                            <div style="margin-top:.4rem;">
                                <a href="{{ p.url }}" target="_blank" class="secondary">View in store →</a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div style="width:200px;height:200px;background:#f3f3f3;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#aaa;">
                            No image
                        </div>
                        {% if p.url %}
                            <div style="margin-top:.4rem;">
                                <a href="{{ p.url }}" target="_blank" class="secondary">View in store →</a>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                <div>
                    <h3>
                        <h3><a href="/shopify/products/{{ p.id }}/edit">{{ p.title }}</a></h3>
                            {{ p.title }}
                        </a>
                    </h3>
                    <p>
                        <a href="/shopify/products/{{ p.id }}/edit" class="secondary">Edit product</a>
                        <a href="/shopify/products/{{ p.id }}/lifestyle" class="secondary">Lifestyle images</a>
                    </p>
                    {% if p.type %}<p><b>Type:</b> {{ p.type }}</p>{% endif %}
                    {% if p.description %}
                        <details class="desc-wrap">
                            <summary>Show description</summary>
                            <div class="desc fade">
                                {{ p.description | safe }}
                            </div>
                        </details>
                    {% endif %}
                    {% if p.tags %}
                        <p class="tags">{% for t in p.tags %}<span>{{ t }}</span>{% endfor %}</p>
                    {% endif %}
                    <p class="muted">
                        {% if p.created_at %}
                            Created: {{ pretty_date(p.created_at) }}
                        {% elif p.updated_at %}
                            Updated: {{ pretty_date(p.updated_at) }}
                        {% endif %}
                    </p>
                    {% set sm = p.swatch_mapping or {} %}
                    {% set sm_state = (sm.state or 'unknown') %}
                    {% if sm_state == 'mapped' %}
                        <p class="swatch-state swatch-ok">
                            Swatches: mapped ({{ sm.linked_after or 0 }}/{{ sm.total_color_values or 0 }})
                        </p>
                    {% elif sm_state in ['needs_mapping', 'unknown'] %}
                        <p class="swatch-state swatch-warn">
                            Swatches: needs mapping ({{ sm.linked_after or 0 }}/{{ sm.total_color_values or 0 }})
                        </p>
                    {% elif sm_state == 'no_color_option' %}
                        <p class="swatch-state swatch-unknown">
                            Swatches: n/a (no color option)
                        </p>
                    {% endif %}
                    {% if sm.last_attempt_at %}
                        <p class="muted">Swatch check: {{ pretty_date(sm.last_attempt_at) }}</p>
                    {% endif %}

                    {% if p.color_variants %}
                        <div>
                            <b>Colors:</b>
                            <div class="color-grid">
                                {% for cv in p.color_variants %}
                                    <div class="color-item" title="{{ cv.color }}">
                                        {% if cv.image %}
                                            <img src="{{ cv.image }}" alt="{{ p.title }} - {{ cv.color }}">
                                        {% else %}
                                            <div style="width:72px;height:72px;background:#f3f3f3;border-radius:8px;border:1px solid #e6e6e6;"></div>
                                        {% endif %}
                                        <span class="label">{{ cv.color }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </article>
    {% endfor %}

    {% if pager and not pager.show_all and pager.total_pages > 1 %}
    <div class="pager" style="margin-top:1rem;">
        <div class="pager-info">Page {{ pager.page }} of {{ pager.total_pages }}</div>
        <div class="pager-actions">
            {% if pager.has_prev %}
                <a href="{{ pager.prev_url }}" role="button" class="secondary">← Prev</a>
            {% endif %}
            <div class="pager-jumps">
                <a href="{{ url_for('shopify_pages.products_page', page=1) }}" role="button" class="{{ 'primary' if pager.page == 1 else 'secondary' }}">1</a>
                {% set window_start = [2, pager.page - 1] | max %}
                {% set window_end = [pager.total_pages - 1, pager.page + 3] | min %}
                {% if window_start > 2 %}<span class="ellipsis">…</span>{% endif %}
                {% for n in range(window_start, window_end + 1) %}
                    <a href="{{ url_for('shopify_pages.products_page', page=n) }}" role="button" class="{{ 'primary' if n == pager.page else 'secondary' }}">{{ n }}</a>
                {% endfor %}
                {% if window_end < pager.total_pages - 1 %}<span class="ellipsis">…</span>{% endif %}
                {% if pager.total_pages > 1 %}
                    <a href="{{ url_for('shopify_pages.products_page', page=pager.total_pages) }}" role="button" class="{{ 'primary' if pager.page == pager.total_pages else 'secondary' }}">{{ pager.total_pages }}</a>
                {% endif %}
            </div>
            {% if pager.has_next %}
                <a href="{{ pager.next_url }}" role="button" class="secondary">Next →</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</main>

<script>
    document.getElementById('updateBtn').addEventListener('click', async () => {
        const btn = document.getElementById('updateBtn');
        btn.setAttribute('aria-busy', 'true');
        try {
            const res = await fetch('/api/products/cache/update', {method: 'POST'});
            await res.json();
            location.reload();
        } catch (e) {
            alert('Failed to update cache');
        }
    });
</script>
</body>
</html>
